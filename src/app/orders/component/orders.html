<p-toast></p-toast>
<p-confirmdialog></p-confirmdialog>

<p-toolbar>
    <ng-template #start>
        @if(this.typeorders==='me'){
        <p-button label="New" icon="pi pi-plus" severity="secondary"
            class="mr-2" (onClick)="openNew()" />
        }
    </ng-template>

    <ng-template #end>
        <div class="flex items-center gap-2">
            <label for="date_from" class="mr-1">Desde:</label>
            <p-datepicker [(ngModel)]="date_from" (onSelect)="getOrders()"
                dateFormat="yy-mm-dd" id="date_from"
                placeholder="Date From"></p-datepicker>
            <label for="date_to" class="mr-1">Hasta:</label>
            <p-datepicker [(ngModel)]="date_to" (onSelect)="getOrders()"
                dateFormat="yy-mm-dd" placeholder="Date To"
                id="date_to"></p-datepicker>
        </div>
    </ng-template>
</p-toolbar>

<p-table #dt [value]="lista" [rows]="perPage" [paginator]="true" [lazy]="true"
    [tableStyle]="{ 'min-width': '75rem' }"
    [rowHover]="true" (onPage)="onPageChange($event)" [totalRecords]="total"
    dataKey="id" [(first)]="first"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} orders"
    [showCurrentPageReport]="true">
    <ng-template #caption>
        <div class="flex items-center justify-between">
            <h5 class="m-0">Manage Orders</h5>
            <div>

                <p-select id="type" [(ngModel)]="type" [options]="orderTypes"
                    optionLabel="name" optionValue="value"
                    (onChange)="getOrders()" placeholder="Select Type"
                    class="w-full"></p-select>
            </div>
        </div>
    </ng-template>

    <ng-template #header>
        <tr>
            <th style="min-width: 3rem">Id </th>
            <th style="min-width: 3rem"></th>
            <th style="min-width: 3rem">Status </th>
            <th style="min-width: 3rem">Waiter Owner</th>
            <th style="min-width: 3rem">Date</th>
            <th style="min-width: 5rem">Final Price</th>
            <th style="min-width: 5rem">Waiter Comision</th>
            <th style="min-width: 3rem">Updated Date</th>
        </tr>
    </ng-template>
    <ng-template #body let-order>
        <tr>
            <td>{{order.id}}</td>
            <td>
                @if (this.typeorders==='me'){
                @if(order.status === 'OPEN' && (this.getCurrentUser().id ===
                order.waiter.id || (this.getCurrentUser().type === 'IN_CHARGE'
                || this.getCurrentUser().type === 'ADMINISTRATOR'))){
                <p-button icon="pi pi-pencil" severity="info" class="mr-2"
                    (click)="editOrder(order)" pTooltip="Edit Order"></p-button>
                }
                @if(order.status === 'OPEN' && (this.getCurrentUser().id ===
                order.waiter.id)){
                <p-button icon="pi pi-times-circle" severity="info"
                    (click)="closeOrder(order)"
                    pTooltip="Close Order" class="mr-2"></p-button>
                }
                @if(order.status === 'CLOSED' &&
                (
                this.getCurrentUser().type === 'IN_CHARGE')){
                <p-button icon="pi pi-dollar" severity="success" class="mr-2"
                    (click)="paidOrder(order)"
                    pTooltip="Mark as Paid Order"></p-button>
                }
                @if(
                (order.status === 'CLOSED' || order.status === 'PAID' ||
                order.status === 'COMISSIONED') &&
                (this.getCurrentUser().type === 'IN_CHARGE' ||
                this.getCurrentUser().type === 'ADMINISTRATOR')
                ){
                <p-button icon="pi pi-exclamation-triangle" severity="danger"
                    class="mr-2"
                    (click)="voidedOrder(order)"
                    pTooltip="Voided Order"></p-button>
                }
                }
                <p-button icon="pi pi-eye" severity="success"
                    class="mr-2"
                    (click)="viewOrder(order)"
                    pTooltip="View Order"></p-button>
            </td>
            <td>
                <p-tag [value]="order.status"
                    [severity]="getStatusSeverity(order.status)"></p-tag>
            </td>

            <td>{{order.waiter.first_name}} {{order.waiter.last_name}}</td>
            <td>{{order.order_date | date:'yyyy-MM-dd'}}</td>
            <td>{{order.price_final | currency:'USD'}}</td>
            <td>{{order.waiter_comision ?? 0 | currency:'USD'}}</td>
            <td>{{order.updated_at | date:'yyyy-MM-dd'}}</td>
        </tr>
    </ng-template>
</p-table>

<p-dialog [(visible)]="orderDialog" [breakpoints]="{'768px': '100vw'}"
    [style]="{width: '90vw', height: '90vh'}" (onHide)="onHide()"
    header="Order Details" [modal]="true">
    <ng-template pTemplate="content">
        <div class="flex flex-row flex-wrap gap-4">
            <div>
                <label class="block font-bold mb-1">Order ID</label>
                <div>{{ currentOrder.id }}</div>
            </div>
            <div>
                <label class="block font-bold mb-1">Status</label>
                <p-tag [value]="currentOrder.status"
                    [severity]="getStatusSeverity(currentOrder.status || '')"></p-tag>
            </div>
            <div>
                <label class="block font-bold mb-1">Waiter</label>
                <div>{{ currentOrder.waiter.first_name }} {{
                    currentOrder.waiter.last_name }}</div>
            </div>
            <div>
                <label class="block font-bold mb-1">Date</label>
                <div>{{ currentOrder.order_date | date:'yyyy-MM-dd' }}</div>
            </div>

        </div>
        <div class="mt-4">
            <app-details [order]="currentOrder" [view]="view"></app-details>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <p-button label="Cerrar Session" icon="pi pi-times" severity="danger"
            (click)="logout()"></p-button>
        <p-button label="Close" icon="pi pi-times" severity="secondary"
            (click)="hideDialog()"></p-button>

    </ng-template>
</p-dialog>
